
{
  "rules": {
    "institutions": {
      "$institutionId": {
        ".read": "auth != null && (data.child('ownerId').val() === auth.uid || root.child('userMappings').child(auth.uid).child($institutionId).exists())",
        ".write": "auth != null && ( (newData.child('ownerId').val() === auth.uid && !data.exists()) || (data.child('ownerId').val() === auth.uid) )",
        // Grant read/write access to all sub-collections if the user has access to the institution
        "$other": {
          ".read": "root.child('institutions').child($institutionId).child('ownerId').val() === auth.uid || root.child('userMappings').child(auth.uid).child($institutionId).exists()",
          ".write": "root.child('institutions').child($institutionId).child('ownerId').val() === auth.uid || root.child('userMappings').child(auth.uid).child($institutionId).exists()"
        }
      }
    },
    "userMappings": {
       "$userId": {
         // A user can only read/write their own mapping data
         ".read": "auth != null && auth.uid === $userId",
         ".write": "auth != null && auth.uid === $userId"
       }
    }
  }
}
