
{
  "rules": {
    "institutions": {
      "$institutionId": {
        ".read": "auth != null && (data.child('ownerId').val() === auth.uid || root.child('userMappings').child(auth.uid).child($institutionId).exists())",
        
        "roles": {
          ".write": "auth != null && root.child('institutions').child($institutionId).child('ownerId').val() === auth.uid",
          "$roleId": {
            ".validate": "newData.hasChild('name') && newData.hasChild('permissions')"
          }
        },
        
        "$collection": {
          ".read": "auth != null && (data.parent().child('ownerId').val() === auth.uid || root.child('userMappings').child(auth.uid).child($institutionId).exists())",
          "$docId": {
             ".write": "auth != null && newData.exists() && (data.parent().parent().child('ownerId').val() === auth.uid || root.child('userMappings').child(auth.uid).child($institutionId).exists())"
          }
        }
      },
      ".write": "auth != null && newData.hasChild('ownerId')"
    },
    "userMappings": {
       "$userId": {
         ".read": "auth != null && auth.uid === $userId",
         ".write": "auth != null"
       }
    }
  }
}
