
{
  "rules": {
    "app_settings": {
      ".read": true,
      "isSuperAdminRegistered": {
        ".write": "auth != null && !data.exists()"
      }
    },
    "institutions": {
      "$institutionId": {
        // Allow write if user is the owner, or if creating a new institution and the user is the owner in the newData
        ".write": "auth != null && (data.child('ownerId').val() === auth.uid || (newData.child('ownerId').val() === auth.uid && !data.exists()))",
        // Allow read if user is the owner or is mapped to this institution
        ".read": "auth != null && (data.child('ownerId').val() === auth.uid || root.child('userMappings').child(auth.uid + '_' + $institutionId).exists())",

        // Any authenticated user mapped to the institution can read/write data within it, further restricted by app logic and permissions
        "roles": { ".read": "auth != null", ".write": "auth != null" },
        "customers": { ".read": "auth != null", ".write": "auth != null" },
        "suppliers": { ".read": "auth != null", ".write": "auth != null" },
        "business-partners": { ".read": "auth != null", ".write": "auth != null" },
        "transactions": { ".read": "auth != null", ".write": "auth != null" },
        "purchases": { ".read": "auth != null", ".write": "auth != null" },
        "purchase-returns": { ".read": "auth != null", ".write": "auth != null" },
        "expenses": { ".read": "auth != null", ".write": "auth != null" },
        "other-incomes": { ".read": "auth != null", ".write": "auth != null" },
        "investments": { ".read": "auth != null", ".write": "auth != null" },
        "cash-advances": { ".read": "auth != null", ".write": "auth != null" },
        "customer-payments": { ".read": "auth != null", ".write": "auth != null" },
        "supplier-payments": { ".read": "auth != null", ".write": "auth != null" },
        "employees": { ".read": "auth != null", ".write": "auth != null" },
        "bank-accounts": { ".read": "auth != null", ".write": "auth != null" },
        "tank-readings": { ".read": "auth != null", ".write": "auth != null" },
        "settings": { ".read": "auth != null", ".write": "auth != null" }
      }
    },
    "userMappings": {
       "$mappingId": {
         ".read": "auth != null && data.child('userId').val() === auth.uid",
         // Allow creating a mapping if the user is creating it for themselves, or if the user is an admin of that institution
         ".write": "auth != null && ( (newData.child('userId').val() === auth.uid && !data.exists()) || (root.child('userMappings').child(auth.uid + '_' + newData.child('institutionId').val()).child('roleId').val() === 'admin') )"
       }
    }
  }
}
